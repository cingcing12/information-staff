<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Directory - Ultimate Profile View</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- Base Setup --- */
        :root {
            --color-primary: #1a73e8; /* Google Blue */
            --color-primary-dark: #0c4a6e;
            --color-background: #f8faff; /* Very light, cool white */
            --color-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --color-border: #e2e8f0;
        }

        /* --- General Layout & Fonts --- */
        body {
            font-family: 'Inter', sans-serif; 
            margin: 0;
            padding: 0;
            background-color: var(--color-background); 
            color: #333;
        }
        .main-container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- Navigation/Header Improvements --- */
        .navbar {
            background-color: #ffffff;
            border-bottom: 1px solid var(--color-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            padding: 15px 30px;
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            color: var(--color-primary-dark); 
            margin: 0;
            font-weight: 800;
            font-size: 1.8em;
        }
        #staff-count-display {
            font-size: 1em;
            color: #64748b;
            font-weight: 500;
            padding: 5px 10px;
            background-color: #f1f5f9;
            border-radius: 6px;
        }

        /* --- Filters Container UX/UI (Control Panel Aesthetic) --- */
        #filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 40px;
            padding: 30px; /* Increased padding */
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: var(--color-shadow), inset 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle inner shadow */
            align-items: flex-start;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 200px; 
            border-right: 1px solid #f1f5f9; /* Subtle divider */
            padding-right: 20px;
        }
        .filter-group:last-child {
             border-right: none;
             padding-right: 0;
        }
        .filter-group.search-group {
            flex-grow: 3;
            min-width: 300px;
        }
        .filter-group label {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 0.9em;
            letter-spacing: 0.03em;
        }
        .filter-group input, .filter-group select {
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 10px; 
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.03);
        }
        .filter-group input:focus, .filter-group select:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(26, 115, 232, 0.15), inset 0 1px 2px rgba(0, 0, 0, 0.03);
        }

        /* --- Card Grid Layout --- */
        #data-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 30px; 
            margin-bottom: 30px;
        }
        
        /* --- Individual Card Styling (Ultimate Minimal Profile) --- */
        .employee-card {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid var(--color-border); 
            overflow: hidden;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s, outline 0.3s;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            position: relative; 
            text-align: center;
        }
        /* Hover state polish */
        .employee-card:hover {
            transform: translateY(-5px); 
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
            border-color: #a5c3f6; 
        }
        /* Accessibility Focus State */
        .employee-card:focus-within {
            outline: 4px solid rgba(26, 115, 232, 0.5); 
            outline-offset: 2px;
        }


        /* Card Header background (Pseudo-element for clean separation) */
        .employee-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 80px; 
            background-color: #f8faff; 
            border-bottom: 1px solid var(--color-border);
            z-index: 1; 
        }

        /* Card Image/Avatar Container */
        .card-image-container {
            position: relative;
            top: 5px; 
            left: 50%;
            transform: translateX(-50%);
            width: 100px; 
            height: 100px;
            border-radius: 50%; 
            overflow: hidden;
            background-color: #ffffff; 
            border: 5px solid white; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); 
            z-index: 10; 
        }
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Placeholder styling for empty photo */
        .card-image[src="placeholder.jpg"] { content: none; display: block; position: relative; }
        .card-image[src="placeholder.jpg"]::before {
            content: 'üë§'; 
            display: flex; justify-content: center; align-items: center;
            width: 100%; height: 100%; color: #94a3b8; font-size: 3em; 
            background-color: #e2e8f0;
        }
        
        /* Card Content Block */
        .card-content { 
            padding: 15px 25px 25px 25px; 
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            align-items: center; 
            z-index: 5; 
        }
        .card-title { 
            font-size: 1.4em; 
            font-weight: 700; 
            color: #1f2937; 
            margin-bottom: 2px; 
            margin-top: 10px; 
        }
        .card-subtitle { 
            font-size: 0.95em; 
            color: #64748b; 
            margin-bottom: 20px; 
            font-weight: 500;
        }

        /* Detail/Icon Block - Cleaner alignment */
        .card-detail-group {
            width: 100%; 
            border-top: 1px solid #f1f5f9;
            padding-top: 20px;
            text-align: left; 
        }
        .card-detail { 
            margin-bottom: 10px; 
            font-size: 0.9em; 
            color: #475569; 
            display: flex;
            align-items: center;
        }
        .card-detail:last-child {
            margin-bottom: 0;
        }
        .card-detail strong { 
            color: #1f2937; 
            font-weight: 600; 
            margin-left: 8px;
            min-width: 90px; 
        }
        /* --- FINAL POLISH: Circle around Detail Icons --- */
        .card-detail i {
            color: var(--color-primary); 
            width: 25px;
            height: 25px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f4f8; /* Very light background for the circle */
            border-radius: 50%;
            text-align: center;
            font-size: 0.9em; 
            flex-shrink: 0; 
        }

        /* Tag Styling */
        .card-tag { 
            background-color: #e0f2fe; 
            color: #0c4a6e; 
            padding: 8px 15px;
            font-size: 0.85em;
            border-radius: 20px; 
            font-weight: 600;
            margin-top: 25px; 
            align-self: flex-start; 
        }

        /* --- Show More Button Style (Gradient & Enhanced) --- */
        #show-more-container {
            text-align: center;
            padding: 30px 0 50px 0;
            display: flex;
            justify-content: center;
        }
        #show-more-btn {
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 700;
            /* Subtle gradient background */
            background-image: linear-gradient(135deg, #1a73e8 0%, #1764cc 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-image 0.3s, box-shadow 0.3s, transform 0.1s;
            box-shadow: 0 8px 20px rgba(26, 115, 232, 0.4);
            display: none;
        }
        #show-more-btn:hover {
            background-image: linear-gradient(135deg, #1764cc 0%, #0d47a1 100%);
            box-shadow: 0 10px 25px rgba(26, 115, 232, 0.5);
        }
        #show-more-btn:active {
            transform: scale(0.99);
        }

        /* --- SKELETON LOADER STYLES --- */
        .skeleton-card {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid var(--color-border);
            overflow: hidden;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.05);
            height: 350px; /* Fixed height to match real cards */
            position: relative;
            padding-top: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .skeleton-header-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background-color: #f8faff; 
            border-bottom: 1px solid var(--color-border);
        }
        .skeleton-avatar {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #e2e8f0; /* Gray circle for avatar */
            z-index: 10;
        }
        .skeleton-content {
            width: 80%;
            padding-top: 60px; /* Space below avatar */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .skeleton-line {
            width: 100%;
            height: 12px;
            background-color: #e2e8f0;
            border-radius: 4px;
            margin-bottom: 10px;
            animation: pulse 1.5s infinite ease-in-out;
        }
        .skeleton-title {
            width: 70%;
            height: 20px;
            margin-bottom: 15px;
        }
        .skeleton-subtitle {
            width: 50%;
            height: 12px;
            margin-bottom: 25px;
        }
        .skeleton-tag {
            width: 40%;
            height: 10px;
            margin-top: 25px;
        }

        /* Pulsing animation */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* Ensure the skeleton cards take up the full grid width when loading */
        #data-container.loading {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            text-align: initial; 
            align-items: flex-start;
            padding: 0;
        }
        #data-container.loading > p,
        #data-container.loading > i { /* Hide previous 'Loading data...' text/spinner */
            display: none;
        }


        /* --- Responsive Design --- */
        @media (max-width: 992px) {
             .filter-group { border-right: none; padding-right: 0; }
             #filter-container { flex-direction: column; align-items: stretch; }
             .filter-group { min-width: 100%; }
             .filter-group.search-group { min-width: 100%; }
        }
        @media (max-width: 768px) {
            #data-container {
                grid-template-columns: repeat(2, 1fr); 
                gap: 20px;
            }
            #data-container.loading{
                grid-template-columns: repeat(2, 1fr);
            }
            .navbar { flex-direction: column; gap: 5px; }
            h1 { font-size: 1.5em; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üè¢ Employee Directory | ·ûî·ûâ·üí·ûá·û∏·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ</h1>
        <span id="staff-count-display">Loading staff count...</span>
    </div>

    <div class="main-container">

        <div id="filter-container">
            <div class="filter-group search-group">
                <label for="name-search">Search Name/ID (·ûà·üí·ûò·üÑ·üá/·û¢·ûè·üí·ûê·ûõ·üÅ·ûÅ)</label>
                <input type="text" id="name-search" placeholder="Enter name, ID, or Latin name...">
            </div>
            <div class="filter-group">
                <label for="department-filter">Filter by Department (·ûï·üí·ûì·üÇ·ûÄ·ûÄ·û∂·ûö·ûÑ·û∂·ûö)</label>
                <select id="department-filter">
                    <option value="">-- All Departments --</option>
                    </select>
            </div>
            <div class="filter-group">
                <label for="sort-control">Sort By</label>
                <select id="sort-control">
                    <option value="nameKh">Name (Khmer) A-Z</option>
                    <option value="nameLatin">Name (Latin) A-Z</option>
                    <option value="idDi">ID Ascending</option>
                </select>
            </div>
        </div>

        <div id="data-container" class="loading">
            </div> 
        
        <div id="show-more-container">
            <button id="show-more-btn" onclick="showMoreCards()">Show 50 More Staff</button>
        </div>
    </div>

    <script>
        // ** CSV Configuration **
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRny6z0kXP2O7d1Yl4tUk0m9J-vo-Ebw72MZIm5Nq2veCqFu18F-0Wgj06XeKyhABjbG1jQmWyQd-Sa/pub?gid=1542294647&single=true&output=csv';
        const dataContainer = document.getElementById('data-container');
        const nameSearch = document.getElementById('name-search');
        const departmentFilter = document.getElementById('department-filter');
        const countDisplay = document.getElementById('staff-count-display');
        const showMoreBtn = document.getElementById('show-more-btn');
        const sortControl = document.getElementById('sort-control');
        
        let rawEmployeeData = [];
        let filteredEmployeeData = [];
        
        // ** Pagination Variables **
        const CARDS_PER_PAGE = 50;
        let currentCardLimit = CARDS_PER_PAGE; 

        // ** üîë COLUMN INDEX MAPPING (0-based) **
        const COL_NAME_KH = 11;     
        const COL_ID_DI = 4;        
        const COL_GROUP_DI = 6;     
        const COL_GENDER = 13;      
        const COL_NAME_LATIN = 12;  
        const COL_DEPARTMENT = 18;  
        const COL_IMAGE_URL = 36;   
        const ROWS_TO_SKIP = 8;     

        // Initialize Intersection Observer (global scope)
        let observer;
        
        // --- UTILITY: DEBOUNCE FUNCTION (Performance Fix) ---
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }
        
        // --- Core Functions ---
        
        function parseCSV(csvText) {
            const rows = csvText.split('\n').filter(row => row.trim() !== '');
            return rows.map(row => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell ? cell.trim().replace(/^"|"$/g, '') : ''));
        }

        // --- Skeleton Render Function (Unchanged) ---
        function renderSkeleton() {
            dataContainer.innerHTML = '';
            dataContainer.classList.add('loading');
            const skeletonCount = window.innerWidth > 768 ? 6 : 4; 
            
            for (let i = 0; i < skeletonCount; i++) {
                const skeletonHTML = `
                    <div class="skeleton-card">
                        <div class="skeleton-header-bg"></div>
                        <div class="skeleton-avatar"></div>
                        <div class="skeleton-content">
                            <div class="skeleton-line skeleton-title"></div>
                            <div class="skeleton-line skeleton-subtitle"></div>
                            <div class="skeleton-line" style="width: 80%; margin-top: 20px;"></div>
                            <div class="skeleton-line" style="width: 75%;"></div>
                            <div class="skeleton-line" style="width: 85%;"></div>
                            <div class="skeleton-line skeleton-tag"></div>
                        </div>
                    </div>
                `;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = skeletonHTML.trim();
                dataContainer.appendChild(tempDiv.firstChild);
            }
        }

        async function fetchDataAndDisplay() {
            renderSkeleton(); 
            
            try {
                const response = await fetch(GOOGLE_SHEETS_URL);
                const csvText = await response.text();
                const dataArray = parseCSV(csvText);
                
                const dataRows = dataArray.slice(ROWS_TO_SKIP);
                
                // **FIX: TRIM and UPPERCASE department name on ingest for strict deduplication**
                rawEmployeeData = dataRows.map(row => ({
                    nameKh: row[COL_NAME_KH] || 'N/A',
                    idDi: row[COL_ID_DI] || 'N/A',
                    groupDi: row[COL_GROUP_DI] || 'N/A',
                    gender: row[COL_GENDER] || 'N/A',
                    nameLatin: row[COL_NAME_LATIN] || 'N/A',
                    department: (row[COL_DEPARTMENT] || 'N/A').trim().toUpperCase(), 
                    imageUrl: (row[COL_IMAGE_URL] || '').replace(/"/g, '').trim() || 'placeholder.jpg' 
                })).filter(employee => employee.nameKh !== 'N/A' && employee.nameLatin !== 'N/A');

                countDisplay.textContent = `Total Staff: ${rawEmployeeData.length}`;
                
                populateDepartmentFilter(rawEmployeeData);
                filterAndRenderCards(false, false); 
                dataContainer.classList.remove('loading');

            } catch (error) {
                console.error('Error fetching or processing sheet data:', error);
                countDisplay.textContent = 'Error loading data.';
                dataContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Error loading data. Please check the network connection and source link.</p>';
                dataContainer.classList.remove('loading');
            }
        }
        
        // --- Sorting Function (No change) ---
        function sortData(data) {
            const sortBy = sortControl.value;

            data.sort((a, b) => {
                const valA = (a[sortBy] || '').toUpperCase();
                const valB = (b[sortBy] || '').toUpperCase();

                if (sortBy === 'idDi') {
                    const numA = parseInt(valA.replace(/\D/g, '')) || 0;
                    const numB = parseInt(valB.replace(/\D/g, '')) || 0;
                    return numA - numB;
                } else {
                    if (valA < valB) return -1;
                    if (valA > valB) return 1;
                    return 0;
                }
            });
            return data;
        }
        
        // --- Pagination Logic (No change) ---
        function showMoreCards() {
            currentCardLimit += CARDS_PER_PAGE;
            renderCards(filteredEmployeeData);
        }

        function updateShowMoreButton() {
            if (filteredEmployeeData.length > currentCardLimit) {
                showMoreBtn.style.display = 'block';
                const remaining = filteredEmployeeData.length - currentCardLimit;
                const showCount = Math.min(CARDS_PER_PAGE, remaining);
                showMoreBtn.textContent = `Show ${showCount} More Staff (Remaining: ${remaining})`;
            } else {
                showMoreBtn.style.display = 'none';
            }
        }

        // --- Intersection Observer Logic (No change in core logic) ---
        const loadCard = (card) => {
            card.classList.add('visible');
            if (observer) {
                observer.unobserve(card);
            }
        };

        const setupObserver = () => {
            if (observer) {
                observer.disconnect();
            }
            
            observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        loadCard(entry.target);
                    }
                });
            }, {
                rootMargin: '100px 0px',
                threshold: 0.01
            });
            
            document.querySelectorAll('.lazy-card').forEach(card => {
                observer.observe(card);
            });
        };


        // --- FIX CONFIRMED: Department filter deduplication is correct ---
        function populateDepartmentFilter(data) {
            // Because department names are now consistently UPPERCASE and trimmed, 
            // the Set guarantees only one entry per unique department.
            const departments = new Set(data.map(item => item.department).filter(dep => dep && dep !== 'N/A'));
            departmentFilter.innerHTML = '<option value="">-- All Departments --</option>';
            
            const sortedDepartments = Array.from(departments).sort();

            sortedDepartments.forEach(dep => {
                const option = document.createElement('option');
                option.value = dep; // E.g., "IT SUPPORT"
                option.textContent = dep; // E.g., "IT SUPPORT"
                departmentFilter.appendChild(option);
            });
        }

        function filterAndRenderCards(resetLimit = true, resetScroll = false) {
            // **Search text must be standardized to UPPERCASE to match data**
            const searchText = nameSearch.value.toUpperCase();
            const selectedDepartment = departmentFilter.value; // Already UPPERCASE from populateFilter

            let processedData = rawEmployeeData.filter(employee => {
                // employee.department is already the standardized UPPERCASE string
                
                // Case-insensitive search on Name/ID/Department
                const matchesSearch = 
                    (employee.nameKh || '').toUpperCase().includes(searchText) || 
                    (employee.nameLatin || '').toUpperCase().includes(searchText) ||
                    (employee.idDi || '').toUpperCase().includes(searchText) ||
                    (employee.department || '').includes(searchText);


                // Department filter match against the standardized string
                const matchesDepartment = 
                    !selectedDepartment || employee.department === selectedDepartment;
                
                return matchesSearch && matchesDepartment;
            });
            
            processedData = sortData(processedData); 
            filteredEmployeeData = processedData;

            if (resetLimit) {
                currentCardLimit = CARDS_PER_PAGE;
            }

            if (searchText || selectedDepartment) {
                countDisplay.textContent = `${filteredEmployeeData.length} Staff Match Filters (Total: ${rawEmployeeData.length})`;
            } else {
                countDisplay.textContent = `Total Staff: ${rawEmployeeData.length}`;
            }

            renderCards(filteredEmployeeData);
        }

        function renderCards(data) {
            dataContainer.innerHTML = ''; 
            dataContainer.classList.remove('loading');

            if (data.length === 0) {
                dataContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #78716c; padding: 50px;">ü§∑‚Äç‚ôÄÔ∏è No employees found matching the current filters.</p>';
                showMoreBtn.style.display = 'none';
                return;
            }

            const limitedData = data.slice(0, currentCardLimit);

            limitedData.forEach(employee => {
                const cardHTML = `
                    <div class="employee-card lazy-card" tabindex="0">
                        <div class="card-image-container">
                            <img class="card-image" src="${employee.imageUrl}" alt="Image of ${employee.nameLatin}" loading="lazy">
                        </div>
                        
                        <div class="card-content">
                            <div class="card-title">${employee.nameKh}</div>
                            <div class="card-subtitle">${employee.nameLatin}</div>
                            
                            <div class="card-detail-group">
                                <div class="card-detail"><i class="fas fa-id-card"></i> <strong>ID DI:</strong> ${employee.idDi}</div>
                                <div class="card-detail"><i class="fas fa-layer-group"></i> <strong>Group DI:</strong> ${employee.groupDi}</div>
                                <div class="card-detail"><i class="fas fa-venus-mars"></i> <strong>Gender:</strong> ${employee.gender}</div>
                            </div>
                            
                            <span class="card-tag"><i class="fas fa-briefcase"></i> ${employee.department}</span>
                        </div>
                    </div>
                `;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cardHTML.trim();
                dataContainer.appendChild(tempDiv.firstChild);
            });
            
            updateShowMoreButton();
            setupObserver();
        }

        // --- ATTACH EVENT LISTENERS (Applying Debounce) ---
        const debouncedFilter = debounce(filterAndRenderCards, 300);

        // Name search uses the debounced function
        nameSearch.addEventListener('input', () => debouncedFilter(true, false)); 
        
        // Department and Sort controls trigger immediately (as they are discrete changes)
        departmentFilter.addEventListener('change', () => filterAndRenderCards(true, false)); 
        sortControl.addEventListener('change', () => filterAndRenderCards(true, false)); 

        document.addEventListener('DOMContentLoaded', fetchDataAndDisplay);
    </script>
</body>
</html>